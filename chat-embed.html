<!-- Chat Widget Embed Code -->
<style>
    #chat-iframe-container {
        position: fixed;
        bottom: 24px;
        right: 24px;
        width: 80px;
        height: 80px;
        z-index: 2147483647;
        transform: scale(1);
        transform-origin: bottom right;
        transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
    }

    #chat-iframe-container.expanded {
        box-shadow: 0 8px 24px rgba(0, 0, 0, 0.12);
    }

    #chat-iframe {
        width: 100%;
        height: 100%;
        border: none;
        border-radius: 50%;
        background: transparent;
        overflow: visible;
        transition: border-radius 0.3s ease;
    }

    /* Mobile styles */
    @media screen and (max-width: 600px) {
        #chat-iframe-container {
            bottom: 16px;
            right: 16px;
            width: 64px;
            height: 64px;
        }

        #chat-iframe-container.expanded {
            width: calc(100% - 32px) !important;
            max-width: 380px;
            height: 80vh !important;
            max-height: 600px;
        }
    }

    /* Tablet and desktop styles */
    @media screen and (min-width: 601px) {
        #chat-iframe-container.expanded {
            width: 380px !important;
            height: 580px !important;
        }
    }

    /* Backdrop for mobile */
    .chat-backdrop {
        position: fixed;
        inset: 0;
        background: rgba(0, 0, 0, 0.3);
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
        z-index: 2147483646;
        backdrop-filter: blur(4px);
        -webkit-backdrop-filter: blur(4px);
    }

    .chat-backdrop.visible {
        opacity: 1;
        pointer-events: auto;
    }

    /* Safe area handling for modern mobile devices */
    @supports(padding: max(0px)) {
        @media screen and (max-width: 600px) {
            #chat-iframe-container {
                bottom: max(16px, env(safe-area-inset-bottom));
                right: max(16px, env(safe-area-inset-right));
            }
        }
    }
</style>

<div id="chat-iframe-container">
    <iframe 
        src="https://vibbaai.netlify.app/?minimal=true" 
        id="chat-iframe"
        title="Customer Support Chat"
        allow="clipboard-write"
        loading="lazy"
    ></iframe>
</div>

<script>
    (function() {
        const container = document.getElementById('chat-iframe-container');
        const iframe = document.getElementById('chat-iframe');
        let isExpanded = false;
        let isResizing = false;

        // Create backdrop for mobile
        const backdrop = document.createElement('div');
        backdrop.className = 'chat-backdrop';
        document.body.appendChild(backdrop);

        // Debounce function
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        // Handle chat resize
        function handleChatResize(isOpen) {
            if (isResizing) return;
            isResizing = true;

            requestAnimationFrame(() => {
                isExpanded = isOpen;
                container.classList.toggle('expanded', isExpanded);
                backdrop.classList.toggle('visible', isExpanded && window.innerWidth <= 600);
                iframe.style.borderRadius = isExpanded ? '12px' : '50%';
                
                // Reset transform on mobile when expanded
                if (window.innerWidth <= 600) {
                    container.style.transform = isExpanded ? 'translate(-50%, 0)' : 'none';
                    container.style.left = isExpanded ? '50%' : 'auto';
                }

                setTimeout(() => {
                    isResizing = false;
                }, 300); // Match transition duration
            });
        }

        // Handle messages from iframe
        window.addEventListener('message', function(e) {
            if (e.data.type === 'chatResize') {
                handleChatResize(e.data.isOpen);
            }
        }, false);

        // Handle backdrop clicks
        backdrop.addEventListener('click', () => {
            if (isExpanded) {
                iframe.contentWindow.postMessage({ type: 'closeChat' }, '*');
            }
        });

        // Handle window resize
        const handleResize = debounce(() => {
            if (isExpanded) {
                backdrop.classList.toggle('visible', window.innerWidth <= 600);
                
                // Adjust position on mobile
                if (window.innerWidth <= 600) {
                    container.style.transform = 'translate(-50%, 0)';
                    container.style.left = '50%';
                } else {
                    container.style.transform = 'none';
                    container.style.left = 'auto';
                }
            }
        }, 100);

        window.addEventListener('resize', handleResize);

        // Handle page visibility
        document.addEventListener('visibilitychange', () => {
            if (document.hidden && isExpanded && window.innerWidth <= 600) {
                iframe.contentWindow.postMessage({ type: 'closeChat' }, '*');
            }
        });

        // Handle escape key
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape' && isExpanded) {
                iframe.contentWindow.postMessage({ type: 'closeChat' }, '*');
            }
        });

        // Handle orientation change
        window.addEventListener('orientationchange', () => {
            if (isExpanded) {
                handleResize();
            }
        });

        // Prevent iframe from capturing focus when closed
        if (!isExpanded) {
            iframe.setAttribute('tabindex', '-1');
        }
    })();
</script>